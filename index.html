<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121215">
    <meta name="robots" content="noindex, nofollow">
    <title>La Cuve de Pech</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #121215;
            --bg-secondary: #1a1a1e;
            --bg-card: #222228;
            --text-primary: #e8e8e8;
            --text-secondary: #6a6a6a;
            --accent: #f5a623;
            --accent-soft: rgba(245, 166, 35, 0.15);
            --success: #4cd964;
            --warning: #ff9500;
            --danger: #ff3b30;
            --info: #5ac8fa;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        @media (orientation: landscape) {
            .portrait-only { display: none !important; }
            .bottom-nav { display: none; }
            
            .landscape-chart {
                position: fixed;
                inset: 0;
                background: var(--bg-primary);
                display: flex;
                flex-direction: column;
                padding: 10px;
                z-index: 500;
            }
            
            .landscape-chart .chart-container {
                flex: 1;
            }
            
            .landscape-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
            }
        }

        @media (orientation: portrait) {
            .landscape-only { display: none; }
        }

        /* Pages */
        .page {
            display: none;
            height: calc(100vh - 70px);
            height: calc(100dvh - 70px);
            overflow-y: auto;
            padding: 16px;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 12px 0;
            flex-shrink: 0;
        }

        .header h1 {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.4rem;
            font-weight: 300;
            color: var(--text-primary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Tank Section */
        .tank-section {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            padding: 16px 0;
        }

        .tank-wrapper {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .tank-container {
            width: clamp(160px, 45vw, 240px);
            height: clamp(240px, 50vh, 400px);
            max-height: 100%;
            position: relative;
        }

        .tank {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 50%, #0f0f0f 100%);
            border-radius: 999px;
            overflow: hidden;
            border: 3px solid #3a3a3a;
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.8),
                0 10px 40px rgba(0,0,0,0.5);
        }

        .liquid-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border-radius: 0 0 999px 999px;
        }

        .liquid {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #d4a832 0%, #c9a227 40%, #b89220 100%);
        }

        .liquid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 5%;
            right: 5%;
            height: 8px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 0 0 50% 50%;
        }

        /* Glass reflection */
        .tank-glass {
            position: absolute;
            top: 20px;
            left: 15px;
            width: 20px;
            bottom: 20px;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
            border-radius: 999px;
            pointer-events: none;
        }

        .tank-glass-right {
            position: absolute;
            top: 40px;
            right: 20px;
            width: 8px;
            height: 60px;
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 100%);
            border-radius: 999px;
            pointer-events: none;
        }

        /* Center circle indicator */
        .tank-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(100px, 32vw, 160px);
            height: clamp(100px, 32vw, 160px);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            box-shadow: 
                0 4px 20px rgba(0,0,0,0.3),
                inset 0 0 20px rgba(255,255,255,0.05),
                0 0 0 8px rgba(255,255,255,0.15);
            cursor: pointer;
        }

        .tank-indicator .level-value {
            font-size: clamp(1.6rem, 7vw, 2.4rem);
            font-weight: 600;
            color: #fff;
            line-height: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .tank-indicator .level-unit {
            font-size: clamp(0.65rem, 2.5vw, 0.85rem);
            color: rgba(255,255,255,0.7);
            margin-top: 2px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tank-indicator .level-percent {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            color: rgba(255,255,255,0.9);
            margin-top: 6px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.5);
            font-weight: 600;
        }

        /* Bottom cards */
        .bottom-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 8px;
            flex-shrink: 0;
        }

        .status-text {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 8px 0;
        }

        .status-text.critical { color: #ff3b30; }
        .status-text.low { color: #ff9500; }
        .status-text.medium { color: #ffcc00; }
        .status-text.good { color: #4cd964; }
        .status-text.full { color: #5ac8fa; }

        .cards-row {
            display: flex;
            gap: 8px;
        }

        .info-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            text-align: center;
        }

        .info-card .label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .info-card .value {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .info-card .value.info { color: var(--info); }
        .info-card .value.accent { color: var(--accent); }
        .info-card .value.success { color: var(--success); }

        .info-card .percentage {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .status-critical { background: rgba(255,59,48,0.2); color: #ff3b30; }
        .status-low { background: rgba(255,149,0,0.2); color: #ff9500; }
        .status-medium { background: rgba(255,204,0,0.2); color: #ffcc00; }
        .status-good { background: rgba(76,217,100,0.2); color: #4cd964; }
        .status-full { background: rgba(90,200,250,0.2); color: #5ac8fa; }

        /* Stats Page */
        .stats-page {
            gap: 8px;
            padding-top: 12px;
        }

        /* Stats Swiper */
        .stats-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .stats-swiper {
            flex: 1;
            display: flex;
            transition: transform 0.2s ease-out;
            min-height: 0;
        }

        .stats-slide {
            min-width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 8px 0;
        }

        .pagination-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--bg-card);
            transition: all 0.3s;
        }

        .pagination-dot.active {
            background: var(--accent);
            width: 20px;
            border-radius: 3px;
        }

        /* Stats Grid - Compact */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stats-grid .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .stats-grid .stat-card.full-width {
            grid-column: span 2;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:active {
            opacity: 0.8;
        }

        .stat-card.no-bg {
            background: transparent;
        }

        .stat-card.green-text .value {
            color: var(--success);
        }

        .stat-card.grey-text .value {
            color: #aaa;
        }

        .stat-card .value.green-value {
            color: var(--success);
        }

        .stat-card .value.red-value {
            color: #ff6b6b;
        }

        /* Refill highlight cards */
        .refill-highlight {
            text-align: center;
            padding: 10px;
        }

        .refill-info {
            font-size: 0.85rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .refill-info .date {
            font-weight: 500;
            color: var(--text-primary);
        }

        .refill-info .prefix {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .refill-info .val {
            font-weight: 600;
        }

        .refill-info .val.success { color: var(--success); }
        .refill-info .val.accent { color: var(--accent); }
        .refill-info .val.info { color: var(--info); }

        /* Consumption card */
        .consumption-card {
            padding: 14px;
        }

        .consumption-card .label {
            text-align: center;
            margin-bottom: 12px;
        }

        .consumption-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .consumption-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .consumption-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #aaa;
        }

        .consumption-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        .stat-card .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-card .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-card .value.success { color: var(--success); }
        .stat-card .value.info { color: var(--info); }
        .stat-card .value.accent { color: var(--accent); }
        .stat-card .value.danger { color: var(--danger); }
        .stat-card .value.warning { color: var(--warning); }

        /* Delivery Navigator - Bottom of slide 1 */
        .delivery-nav {
            display: flex;
            align-items: stretch;
            gap: 10px;
            margin-top: auto;
            padding-top: 12px;
            height: 120px;
        }

        .nav-arrow {
            width: 60px;
            background: transparent;
            border: none;
            border-radius: 14px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-arrow:active {
            opacity: 0.6;
        }

        .nav-arrow svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        .delivery-display {
            flex: 1;
            background: transparent;
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
        }

        .delivery-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        .delivery-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .delivery-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
        }

        .delivery-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .delivery-info .val {
            font-weight: 600;
        }

        .delivery-info .val.success { color: var(--success); }
        .delivery-info .val.accent { color: var(--accent); }
        .delivery-info .val.info { color: var(--info); }

        .delivery-row {
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .delivery-details span {
            color: var(--text-secondary);
        }

        .delivery-details .val {
            font-weight: 600;
        }

        .delivery-details .val.success { color: var(--success); }
        .delivery-details .val.accent { color: var(--accent); }
        .delivery-details .val.info { color: var(--info); }

        /* Chart */
        .chart-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chart-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .chart-filters {
            display: flex;
            gap: 6px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .filter-btn.active {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .chart-container {
            flex: 1;
            min-height: 0;
        }

        .chart-filters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .chart-filters-grid .filter-btn {
            padding: 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            width: 100%;
        }

        /* History */
        .history-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin: 0 5%;
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .history-list::-webkit-scrollbar {
            display: none;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .history-item:last-child { border-bottom: none; }

        .history-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .history-values {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.9rem;
        }

        .history-level { color: var(--info); font-weight: 500; }
        .history-liters { color: var(--success); }
        .history-price { color: var(--accent); }
        .history-ppl { color: var(--info); }

        .delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.3rem;
            padding: 4px 8px;
            opacity: 0.7;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.55rem;
            padding: 4px 14px;
            cursor: pointer;
        }

        .nav-btn.active { color: var(--text-primary); }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 12px;
            padding-top: 12px;
            overflow-y: auto;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 18px;
            width: 100%;
            max-width: 280px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 14px;
        }

        .modal-input-group {
            margin-bottom: 12px;
        }

        .modal-input-group label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .input-hint {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: right;
        }

        .modal-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .modal-input-row span {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .modal input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .modal input:focus {
            box-shadow: 0 0 0 2px var(--accent);
        }

        .modal-date {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-bottom: 14px;
        }

        .price-preview {
            text-align: center;
            padding: 8px;
            background: var(--accent-soft);
            border-radius: 8px;
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 0.8rem;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn:active { transform: scale(0.98); }
        .modal-btn.primary { background: var(--accent); color: #000; }
        .modal-btn.primary.green { background: var(--success); }
        .modal-btn.primary.danger { background: var(--danger); color: #fff; }
        .modal-btn.secondary { background: var(--bg-secondary); color: var(--text-secondary); }

        .modal-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .modal-icon-svg {
            text-align: center;
            margin-bottom: 12px;
        }

        .modal-title.delete-title {
            color: var(--danger);
            font-size: 1.1rem;
        }

        .modal-subtitle {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .modal input[type="password"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 8px;
            outline: none;
        }

        .modal input[type="password"]:focus {
            box-shadow: 0 0 0 2px var(--danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--success);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 300;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); color: #fff; }

        /* Confirmation Popup */
        .confirmation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(18, 18, 21, 0.98);
            border: 2px solid var(--success);
            border-radius: 20px;
            padding: 30px 50px;
            text-align: center;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .confirmation-popup.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .confirmation-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 8px;
        }

        .confirmation-text {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .confirmation-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Main Page -->
    <div class="page active portrait-only" id="mainPage">
        <div class="header">
            <h1>La Cuve de Pech</h1>
        </div>

        <div class="tank-section">
            <div class="tank-wrapper">
                <div class="tank-container">
                    <div class="tank">
                        <div class="liquid-container" id="liquidContainer">
                            <div class="liquid" id="liquid"></div>
                        </div>
                        <div class="tank-glass"></div>
                        <div class="tank-glass-right"></div>
                        <div class="tank-indicator" id="tankIndicator" onclick="handleTankClick()">
                            <span class="level-value" id="tankLevelValue">--</span>
                            <span class="level-unit">Litres</span>
                            <span class="level-percent" id="tankPercentValue">--%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-cards" id="bottomCards">
            <div class="status-text" id="mainStatusText">BON</div>
        </div>
    </div>

    <!-- Stats Page -->
    <div class="page portrait-only stats-page" id="statsPage">
        <div class="pagination">
            <div class="pagination-dot active" data-slide="0"></div>
            <div class="pagination-dot" data-slide="1"></div>
            <div class="pagination-dot" data-slide="2"></div>
            <div class="pagination-dot" data-slide="3"></div>
            <div class="pagination-dot" data-slide="4"></div>
            <div class="pagination-dot" data-slide="5"></div>
        </div>

        <div class="stats-container">
            <div class="stats-swiper" id="statsSwiper">
                <!-- Slide 1: Stats Grid + Delivery Nav -->
                <div class="stats-slide">
                    <div class="stats-grid">
                        <div class="stat-card no-bg">
                            <div class="label">Prix moyen</div>
                            <div class="value" id="stat-avg-price">-- €/L</div>
                        </div>
                        <div class="stat-card no-bg">
                            <div class="label">Dernier prix</div>
                            <div class="value" id="stat-last-price">-- €/L</div>
                        </div>
                        <div class="stat-card full-width no-bg consumption-card">
                            <div class="label">Consommation</div>
                            <div class="consumption-grid">
                                <div class="consumption-item">
                                    <span class="consumption-value" id="est-daily">--</span>
                                    <span class="consumption-label">/ jour</span>
                                </div>
                                <div class="consumption-item">
                                    <span class="consumption-value" id="est-weekly">--</span>
                                    <span class="consumption-label">/ semaine</span>
                                </div>
                                <div class="consumption-item">
                                    <span class="consumption-value" id="est-monthly">--</span>
                                    <span class="consumption-label">/ mois</span>
                                </div>
                                <div class="consumption-item">
                                    <span class="consumption-value" id="est-yearly">--</span>
                                    <span class="consumption-label">/ an</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card no-bg green-text">
                            <div class="label">Autonomie restante</div>
                            <div class="value" id="est-days">-- jours</div>
                        </div>
                        <div class="stat-card no-bg green-text">
                            <div class="label">Cuve vide le</div>
                            <div class="value" id="est-empty-date">--</div>
                        </div>
                        <div class="stat-card no-bg">
                            <div class="label">Nombre de livraisons</div>
                            <div class="value" id="stats-count">--</div>
                        </div>
                        <div class="stat-card no-bg">
                            <div class="label">Total livré</div>
                            <div class="value" id="stats-total-liters">-- litres</div>
                        </div>
                        <div class="stat-card full-width clickable" onclick="cycleSpentPeriod()">
                            <div class="label" id="spent-label">Total dépensé (2026)</div>
                            <div class="value" id="stats-total-spent">-- €</div>
                        </div>
                        <div class="stat-card full-width no-bg refill-highlight">
                            <div class="refill-info" id="stats-min-refill">--</div>
                        </div>
                        <div class="stat-card full-width no-bg refill-highlight">
                            <div class="refill-info" id="stats-max-refill">--</div>
                        </div>
                    </div>

                    <!-- Delivery Navigator at bottom -->
                    <div class="delivery-nav">
                        <button class="nav-arrow" onclick="prevDelivery()">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <div class="delivery-display">
                            <div class="delivery-content">
                                <div class="delivery-date" id="deliveryDate">--</div>
                                <div class="delivery-info" id="deliveryInfo">--</div>
                            </div>
                        </div>
                        <button class="nav-arrow" onclick="nextDelivery()">
                            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Slide 2: Level Chart -->
                <div class="stats-slide" style="padding-top: 150px; padding-bottom: 150px;">
                    <div class="chart-card" style="height: calc(100% - 20px);">
                        <div class="chart-header">
                            <div class="chart-title">Niveau de la cuve</div>
                        </div>
                        <div class="chart-container"><canvas id="levelChart"></canvas></div>
                    </div>
                    <div class="chart-filters-grid">
                        <button class="filter-btn" onclick="setLevelFilter('3m')">3 mois</button>
                        <button class="filter-btn" onclick="setLevelFilter('6m')">6 mois</button>
                        <button class="filter-btn active" onclick="setLevelFilter('1y')">1 an</button>
                        <button class="filter-btn" onclick="setLevelFilter('all')">Tout</button>
                    </div>
                </div>

                <!-- Slide 3: Price Chart -->
                <div class="stats-slide" style="padding-top: 150px; padding-bottom: 150px;">
                    <div class="chart-card" style="height: calc(100% - 20px);">
                        <div class="chart-header">
                            <div class="chart-title">Prix au litre</div>
                        </div>
                        <div class="chart-container"><canvas id="priceChart"></canvas></div>
                    </div>
                    <div class="chart-filters-grid">
                        <button class="filter-btn" onclick="setPriceFilter('3m')">3 mois</button>
                        <button class="filter-btn" onclick="setPriceFilter('6m')">6 mois</button>
                        <button class="filter-btn" onclick="setPriceFilter('1y')">1 an</button>
                        <button class="filter-btn active" onclick="setPriceFilter('all')">Tout</button>
                    </div>
                </div>

                <!-- Slide 4: Yearly Summary Chart -->
                <div class="stats-slide">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Résumé par année</div>
                        </div>
                        <div class="chart-container"><canvas id="yearlyChart"></canvas></div>
                    </div>
                </div>

                <!-- Slide 5: Readings -->
                <div class="stats-slide">
                    <div class="history-card">
                        <div class="history-title">Lectures de jauge</div>
                        <div class="history-list" id="readings-list"></div>
                    </div>
                </div>

                <!-- Slide 6: Refills -->
                <div class="stats-slide">
                    <div class="history-card">
                        <div class="history-title">Livraisons</div>
                        <div class="history-list" id="refills-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Landscape -->
    <div class="landscape-only landscape-chart" id="landscapeContainer">
        <div class="landscape-header">
            <div class="chart-title">Niveau de la cuve</div>
            <div class="chart-filters">
                <button class="filter-btn" onclick="setFilter('6m')">6 mois</button>
                <button class="filter-btn active" onclick="setFilter('1y')">1 an</button>
                <button class="filter-btn" onclick="setFilter('all')">Tout</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="landscapeChart"></canvas></div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav portrait-only" id="bottomNav">
        <button class="nav-btn active" id="nav-home" onclick="showPage('main')">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Accueil</span>
        </button>
        <button class="nav-btn" onclick="openModal('jauge')">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 6c-3.31 0-6 2.69-6 6h2c0-2.21 1.79-4 4-4s4 1.79 4 4h2c0-3.31-2.69-6-6-6z"/><path d="M13 12l-1.5 4.5L10 12l2-2z"/></svg>
            <span>Jauge</span>
        </button>
        <button class="nav-btn" onclick="openModal('livraison')">
            <svg viewBox="0 0 24 24"><path d="M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
            <span>Livraison</span>
        </button>
        <button class="nav-btn" id="nav-stats" onclick="showPage('stats')">
            <svg viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
            <span>Stats</span>
        </button>
        <button class="nav-btn" onclick="toggleFullscreen()">
            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            <span>Plein écran</span>
        </button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-login">
        <div class="modal">
            <div class="modal-title">Accès</div>
            <div class="modal-input-group">
                <label>Code d'accès</label>
                <input type="password" id="login-code" maxlength="10" placeholder="••••••••••" inputmode="numeric">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="checkLogin()">Entrer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-jauge">
        <div class="modal">
            <div class="modal-title">Niveau Jauge</div>
            <div class="modal-input-group">
                <label>Niveau lu sur la jauge (en litres)</label>
                <input type="number" id="gauge-input" min="0" max="1000" placeholder="1 000 litres max" inputmode="numeric" oninput="if(this.value > 1000) this.value = 1000;">
            </div>
            <div class="modal-input-group">
                <label>Code de validation</label>
                <input type="password" id="gauge-code" maxlength="4" placeholder="••••" inputmode="numeric">
            </div>
            <div class="modal-date">Date : <span id="modal-date-jauge"></span></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('jauge')">Retour</button>
                <button class="modal-btn primary" onclick="addReading()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-livraison">
        <div class="modal">
            <div class="modal-title">Livraison</div>
            <div class="modal-input-group">
                <label>Quantité livrée (litres)</label>
                <input type="number" id="refill-liters" min="0" max="1000" placeholder="1 000 litres max" inputmode="numeric" oninput="if(this.value > 1000) this.value = 1000;">
            </div>
            <div class="modal-input-group">
                <label>Prix total (€)</label>
                <input type="number" id="refill-price" min="0" step="0.01" placeholder="720.00" inputmode="decimal">
            </div>
            <div class="price-preview" id="price-preview" style="display: none;">
                Prix au litre : <span id="calc-price">--</span> €/L
            </div>
            <div class="modal-input-group">
                <label>Code de validation</label>
                <input type="password" id="refill-code" maxlength="4" placeholder="••••" inputmode="numeric">
            </div>
            <div class="modal-date">Date : <span id="modal-date-livraison"></span></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('livraison')">Retour</button>
                <button class="modal-btn primary green" onclick="addRefill()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-delete">
        <div class="modal">
            <div class="modal-icon-svg">
                <svg viewBox="0 0 24 24" width="60" height="60">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="#ff3b30" stroke-width="1.5"/>
                    <path d="M8 8l8 8M16 8l-8 8" stroke="#ff3b30" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="modal-title delete-title">Oops...</div>
            <div class="modal-subtitle">Êtes-vous sûr de vouloir supprimer ?</div>
            <div class="modal-input-group">
                <label>Entrez le code pour valider</label>
                <input type="password" id="delete-code" maxlength="4" placeholder="••••" inputmode="numeric">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDeleteModal()">Annuler</button>
                <button class="modal-btn primary danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <div class="confirmation-popup" id="confirmation-popup">
        <div class="confirmation-value" id="confirmation-value">650 litres</div>
        <div class="confirmation-text" id="confirmation-text">ajouté</div>
        <div class="confirmation-date" id="confirmation-date">aujourd'hui</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const TANK_CAPACITY = 1000;
        const STORAGE_KEY = 'fioul-data-v12';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkUriTgxNZW4sQ_dtvIfX2LdDloLeSFQE",
            authDomain: "cuve-42899.firebaseapp.com",
            databaseURL: "https://cuve-42899-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cuve-42899",
            storageBucket: "cuve-42899.firebasestorage.app",
            messagingSenderId: "54849711974",
            appId: "1:54849711974:web:96257e7f978796ec3fe2a7"
        };

        // Simple hash function
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        const VALID_HASH = '1477856'; // Hash of the secret code

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const INITIAL_DATA = [
            { date: "2015-12-21", level: 1000, liters: 834, price: 550.00 },
            { date: "2017-02-17", level: 1000, liters: 700, price: 609.00 },
            { date: "2017-11-21", level: 1000, liters: 837, price: 703.00 },
            { date: "2018-11-26", level: 1000, liters: 883, price: 892.00 },
            { date: "2019-03-05", level: 1000, liters: 500, price: 499.00 },
            { date: "2019-09-24", level: 1000, liters: 600, price: 617.00 },
            { date: "2020-02-03", level: 1000, liters: 500, price: 495.00 },
            { date: "2020-06-09", level: 1000, liters: 501, price: 401.00 },
            { date: "2021-01-20", level: 1000, liters: 800, price: 631.00 },
            { date: "2021-04-13", level: 1000, liters: 800, price: 720.00 },
            { date: "2021-11-29", level: 1000, liters: 600, price: 678.00 },
            { date: "2022-01-26", level: 1000, liters: 601, price: 697.00 },
            { date: "2022-03-11", level: 1000, liters: 600, price: 1116.00 },
            { date: "2023-01-13", level: 1000, liters: 600, price: 815.00 },
            { date: "2023-03-16", level: 1000, liters: 600, price: 828.00 },
            { date: "2023-12-20", level: 1000, liters: 600, price: 786.00 },
            { date: "2024-02-26", level: 1000, liters: 600, price: 786.00 },
            { date: "2024-12-16", level: 1000, liters: 765, price: 918.00 },
            { date: "2024-12-20", level: 900 },
            { date: "2025-01-08", level: 600 },
            { date: "2025-01-15", level: 500 },
            { date: "2025-01-20", level: 400 },
            { date: "2025-01-29", level: 250 },
            { date: "2025-02-03", level: 1000, liters: 700, price: 847.00 },
            { date: "2025-02-09", level: 900 },
            { date: "2025-02-23", level: 750 },
            { date: "2025-03-06", level: 650 },
            { date: "2025-03-16", level: 600 },
            { date: "2025-04-06", level: 400 },
            { date: "2025-11-29", level: 300 },
            { date: "2025-12-02", level: 230 },
            { date: "2025-12-03", level: 210 },
            { date: "2025-12-04", level: 203 },
            { date: "2025-12-07", level: 180 },
            { date: "2025-12-08", level: 1000, liters: 756, price: 861.00 },
            { date: "2025-12-15", level: 950 },
            { date: "2026-01-05", level: 700 },
            { date: "2026-01-07", level: 650 },
            { date: "2026-01-11", level: 600 },
            { date: "2026-01-13", level: 585 },
            { date: "2026-01-15", level: 550 },
        ];

        let readings = [];
        let refills = [];
        let levelChart = null;
        let priceChart = null;
        let yearlyChart = null;
        let landscapeChart = null;
        let currentSlide = 0;
        let currentDeliveryIndex = 0;
        let spentPeriod = 0;
        let isLoggedIn = false; // 0 = current year, 1 = last year, 2 = all time

        document.addEventListener('DOMContentLoaded', () => {
            initLoginState();
            updateModalDates();
            setupListeners();
            setupSwiper();
            handleOrientation();
        });

        function handleOrientation() {
            const update = () => {
                if (isLoggedIn && window.innerWidth > window.innerHeight) updateLandscapeChart();
                else if (isLoggedIn) updateCharts();
            };
            window.addEventListener('resize', update);
            update();
        }

        function updateLandscapeChart() {
            const filtered = getFilteredReadings(currentLevelFilter);
            const ctx = document.getElementById('landscapeChart');
            if (!ctx) return;
            if (landscapeChart) landscapeChart.destroy();
            landscapeChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels: filtered.map(r => formatDateShort(r.date)), datasets: [{ data: filtered.map(r => r.level), borderColor: '#5ac8fa', backgroundColor: 'rgba(90,200,250,0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8a8a8a', font: { size: 11 }, maxTicksLimit: 12 }, grid: { color: '#2a2a2a' } }, y: { min: 0, max: 1000, ticks: { color: '#8a8a8a', font: { size: 11 } }, grid: { color: '#2a2a2a' } } } }
            });
        }

        function setupSwiper() {
            const swiper = document.getElementById('statsSwiper');
            let startX = 0, currentX = 0, isDragging = false;
            
            swiper.addEventListener('touchstart', e => { 
                startX = e.touches[0].clientX; 
                currentX = startX;
                isDragging = true; 
            });
            swiper.addEventListener('touchmove', e => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                if (Math.abs(diff) > 15) {
                    swiper.style.transform = `translateX(${-currentSlide * 100 + (diff / window.innerWidth) * 100}%)`;
                }
            });
            swiper.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                const diff = currentX - startX;
                if (diff < -60 && currentSlide < 5) currentSlide++;
                else if (diff > 60 && currentSlide > 0) currentSlide--;
                updateSlide();
            });
            document.querySelectorAll('.pagination-dot').forEach(dot => {
                dot.addEventListener('click', () => { currentSlide = parseInt(dot.dataset.slide); updateSlide(); });
            });
        }

        function updateSlide() {
            document.getElementById('statsSwiper').style.transform = `translateX(-${currentSlide * 100}%)`;
            document.querySelectorAll('.pagination-dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            if (currentSlide === 1 || currentSlide === 2 || currentSlide === 3) setTimeout(updateCharts, 50);
        }

        // Delivery Navigator
        function updateDeliveryNav() {
            if (refills.length === 0) {
                document.getElementById('deliveryDate').textContent = 'Aucune livraison';
                document.getElementById('deliveryInfo').textContent = '';
                return;
            }
            const r = refills[refills.length - 1 - currentDeliveryIndex];
            document.getElementById('deliveryDate').textContent = formatDateFull(r.date);
            document.getElementById('deliveryInfo').innerHTML = `<span class="val success">${r.liters} L</span> · <span class="val accent">${r.price} €</span> · <span class="val info">${r.pricePerLiter} €/L</span>`;
        }

        function prevDelivery() {
            if (currentDeliveryIndex < refills.length - 1) {
                currentDeliveryIndex++;
                updateDeliveryNav();
            }
        }

        function nextDelivery() {
            if (currentDeliveryIndex > 0) {
                currentDeliveryIndex--;
                updateDeliveryNav();
            }
        }

        function loadData() {
            // Try to load from Firebase first
            database.ref('cuve').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.readings && data.readings.length > 0) {
                    readings = data.readings || [];
                    refills = data.refills || [];
                    updateUI();
                    console.log('Données chargées depuis Firebase');
                } else {
                    // Load from localStorage or initialize
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const localData = JSON.parse(saved);
                        readings = localData.readings || [];
                        refills = localData.refills || [];
                    } else {
                        INITIAL_DATA.forEach((item, i) => {
                            readings.push({ id: i + 1, date: item.date, level: item.level, type: item.liters ? 'refill' : 'reading' });
                            if (item.liters && item.price) refills.push({ id: i + 1, date: item.date, liters: item.liters, price: item.price, pricePerLiter: (item.price / item.liters).toFixed(3) });
                        });
                    }
                    saveData();
                    updateUI();
                }
            }).catch((error) => {
                console.log('Firebase non disponible, chargement local');
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const localData = JSON.parse(saved);
                    readings = localData.readings || [];
                    refills = localData.refills || [];
                } else {
                    INITIAL_DATA.forEach((item, i) => {
                        readings.push({ id: i + 1, date: item.date, level: item.level, type: item.liters ? 'refill' : 'reading' });
                        if (item.liters && item.price) refills.push({ id: i + 1, date: item.date, liters: item.liters, price: item.price, pricePerLiter: (item.price / item.liters).toFixed(3) });
                    });
                    saveData();
                }
                updateUI();
            });
        }

        function saveData() {
            // Save to localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ readings, refills }));
            // Save to Firebase
            database.ref('cuve').set({ readings, refills }).then(() => {
                console.log('Données sauvegardées sur Firebase');
            }).catch((error) => {
                console.log('Erreur sauvegarde Firebase:', error);
            });
        }

        function updateUI() {
            updateTank();
            updateStats();
            updateEstimations();
            updateStatsPage();
            updateDeliveryNav();
            updateCharts();
            updateHistory();
        }

        function updateTank() {
            const level = readings.length > 0 ? readings[readings.length - 1].level : 0;
            const pct = (level / TANK_CAPACITY) * 100;
            
            const container = document.getElementById('liquidContainer');
            const liquid = document.getElementById('liquid');
            const tankLevelValue = document.getElementById('tankLevelValue');
            const tankPercentValue = document.getElementById('tankPercentValue');
            const statusText = document.getElementById('mainStatusText');
            
            if (container) container.style.height = `${pct}%`;
            if (tankLevelValue) tankLevelValue.textContent = level ? `${level}` : '--';
            if (tankPercentValue) tankPercentValue.textContent = level ? `${Math.round(pct)}%` : '--%';
            
            // Golden color for liquid
            if (liquid) liquid.style.background = 'linear-gradient(180deg, #d4a832 0%, #c9a227 40%, #b89220 100%)';
            
            let statusLabel, statusClass;
            if (level <= 100) {
                statusLabel = 'Critique'; statusClass = 'critical';
            } else if (level <= 250) {
                statusLabel = 'Bas'; statusClass = 'low';
            } else if (level <= 500) {
                statusLabel = 'Moyen'; statusClass = 'medium';
            } else if (level <= 800) {
                statusLabel = 'Bon'; statusClass = 'good';
            } else {
                statusLabel = 'Plein'; statusClass = 'full';
            }
            
            if (statusText) {
                statusText.textContent = statusLabel;
                statusText.className = 'status-text ' + statusClass;
            }
        }

        function updateEstimations() {
            const recentReadings = readings.filter(r => r.type !== 'refill').slice(-10);
            let dailyConsumption = 0;
            
            if (recentReadings.length >= 2) {
                let totalDrop = 0, totalDays = 0;
                for (let i = 1; i < recentReadings.length; i++) {
                    const prev = recentReadings[i - 1], curr = recentReadings[i];
                    const drop = prev.level - curr.level;
                    if (drop > 0) {
                        const days = (new Date(curr.date) - new Date(prev.date)) / (1000 * 60 * 60 * 24);
                        if (days > 0) { totalDrop += drop; totalDays += days; }
                    }
                }
                if (totalDays > 0) dailyConsumption = totalDrop / totalDays;
            }
            
            const level = readings.length > 0 ? readings[readings.length - 1].level : 0;
            const daysLeft = dailyConsumption > 0 ? Math.floor(level / dailyConsumption) : 0;
            const emptyDate = new Date();
            emptyDate.setDate(emptyDate.getDate() + daysLeft);
            
            const months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
            
            if (dailyConsumption > 0) {
                document.getElementById('est-daily').textContent = `${dailyConsumption.toFixed(1)} L`;
                document.getElementById('est-weekly').textContent = `${(dailyConsumption * 7).toFixed(0)} L`;
                document.getElementById('est-monthly').textContent = `${(dailyConsumption * 30).toFixed(0)} L`;
                document.getElementById('est-days').textContent = `${daysLeft} jours`;
                document.getElementById('est-empty-date').textContent = `${emptyDate.getDate()} ${months[emptyDate.getMonth()]} ${emptyDate.getFullYear()}`;
            }
            
            // Yearly consumption based on actual refill history
            if (refills.length >= 2) {
                const firstDate = new Date(refills[0].date);
                const lastDate = new Date(refills[refills.length - 1].date);
                const totalYears = (lastDate - firstDate) / (1000 * 60 * 60 * 24 * 365);
                const totalLiters = refills.reduce((s, r) => s + r.liters, 0);
                if (totalYears > 0) {
                    const yearlyAvg = Math.round(totalLiters / totalYears);
                    document.getElementById('est-yearly').textContent = `${yearlyAvg.toLocaleString()} litres`;
                }
            }
            
            // Min/Max refills by price per liter
            if (refills.length > 0) {
                const sortedByPPL = [...refills].sort((a, b) => parseFloat(a.pricePerLiter) - parseFloat(b.pricePerLiter));
                const minRefill = sortedByPPL[0];
                const maxRefill = sortedByPPL[sortedByPPL.length - 1];
                
                document.getElementById('stats-min-refill').innerHTML = `<span class="prefix">−</span> <span class="val success">${minRefill.liters} L</span> · <span class="val accent">${minRefill.price} €</span> · <span class="val info">${minRefill.pricePerLiter} €/L</span> · <span class="date">${formatDateFull(minRefill.date)}</span>`;
                
                document.getElementById('stats-max-refill').innerHTML = `<span class="prefix">+</span> <span class="val success">${maxRefill.liters} L</span> · <span class="val accent">${maxRefill.price} €</span> · <span class="val info">${maxRefill.pricePerLiter} €/L</span> · <span class="date">${formatDateFull(maxRefill.date)}</span>`;
            }
        }

        function updateStats() {
            const totalL = refills.reduce((s, r) => s + r.liters, 0);
            const totalP = refills.reduce((s, r) => s + r.price, 0);
            const avg = totalL > 0 ? (totalP / totalL).toFixed(2) : '--';
            const last = refills.length > 0 ? refills[refills.length - 1].pricePerLiter : '--';
            
            document.getElementById('stat-avg-price').textContent = `${avg} €/L`;
            document.getElementById('stat-last-price').textContent = `${last} €/L`;
        }

        function updateStatsPage() {
            const totalL = refills.reduce((s, r) => s + r.liters, 0);
            
            document.getElementById('stats-count').textContent = refills.length || '--';
            document.getElementById('stats-total-liters').textContent = totalL > 0 ? `${totalL.toLocaleString()} L` : '-- L';
            
            updateSpentDisplay();
        }

        function cycleSpentPeriod() {
            spentPeriod = (spentPeriod + 1) % 3;
            updateSpentDisplay();
        }

        function updateSpentDisplay() {
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            let filteredRefills;
            let label;
            
            if (spentPeriod === 0) {
                filteredRefills = refills.filter(r => new Date(r.date).getFullYear() === currentYear);
                label = `Total dépensé (${currentYear})`;
            } else if (spentPeriod === 1) {
                filteredRefills = refills.filter(r => new Date(r.date).getFullYear() === lastYear);
                label = `Total dépensé (${lastYear})`;
            } else {
                filteredRefills = refills;
                label = 'Total dépensé (depuis le début)';
            }
            
            const totalP = filteredRefills.reduce((s, r) => s + r.price, 0);
            
            document.getElementById('spent-label').textContent = label;
            document.getElementById('stats-total-spent').textContent = totalP > 0 ? `${totalP.toLocaleString()} €` : '-- €';
        }

        function updateCharts() {
            updateLevelChart();
            updatePriceChart();
            updateYearlyChart();
        }

        function updateLevelChart() {
            const filtered = getFilteredReadings(currentLevelFilter);
            const ctx1 = document.getElementById('levelChart');
            if (ctx1) {
                if (levelChart) levelChart.destroy();
                levelChart = new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: { labels: filtered.map(r => formatDateShort(r.date)), datasets: [{ data: filtered.map(r => r.level), borderColor: '#5ac8fa', backgroundColor: 'rgba(90,200,250,0.1)', fill: true, tension: 0.4, pointRadius: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8a8a8a', font: { size: 9 }, maxTicksLimit: 6 }, grid: { color: '#2a2a2a' } }, y: { min: 0, max: 1000, ticks: { color: '#8a8a8a', font: { size: 9 } }, grid: { color: '#2a2a2a' } } } }
                });
            }
        }

        function updatePriceChart() {
            const filtered = getFilteredRefills(currentPriceFilter);
            const ctx2 = document.getElementById('priceChart');
            if (ctx2) {
                if (priceChart) priceChart.destroy();
                priceChart = new Chart(ctx2.getContext('2d'), {
                    type: 'line',
                    data: { labels: filtered.map(r => formatDateShort(r.date)), datasets: [{ data: filtered.map(r => parseFloat(r.pricePerLiter)), borderColor: '#f5a623', backgroundColor: 'rgba(245,166,35,0.1)', fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#f5a623' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8a8a8a', font: { size: 9 }, maxTicksLimit: 6 }, grid: { color: '#2a2a2a' } }, y: { ticks: { color: '#8a8a8a', font: { size: 9 }, callback: v => v.toFixed(1) + '€' }, grid: { color: '#2a2a2a' } } } }
                });
            }
        }

        function updateYearlyChart() {
            const ctx = document.getElementById('yearlyChart');
            if (!ctx) return;
            
            // Group refills by year
            const yearlyData = {};
            refills.forEach(r => {
                const year = new Date(r.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { liters: 0, price: 0 };
                }
                yearlyData[year].liters += r.liters;
                yearlyData[year].price += r.price;
            });
            
            // Sort years from recent to old
            const years = Object.keys(yearlyData).sort((a, b) => b - a);
            const litersData = years.map(y => yearlyData[y].liters);
            const priceData = years.map(y => yearlyData[y].price);
            
            if (yearlyChart) yearlyChart.destroy();
            yearlyChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Litres',
                            data: litersData,
                            backgroundColor: 'rgba(90, 200, 250, 0.8)',
                            borderColor: '#5ac8fa',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'Prix (€)',
                            data: priceData,
                            backgroundColor: 'rgba(245, 166, 35, 0.8)',
                            borderColor: '#f5a623',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#8a8a8a',
                                font: { size: 10 },
                                boxWidth: 12
                            }
                        },
                        datalabels: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8a8a8a', font: { size: 9 } },
                            grid: { color: '#2a2a2a' }
                        },
                        y: {
                            ticks: { color: '#8a8a8a', font: { size: 10 } },
                            grid: { color: '#2a2a2a' }
                        }
                    }
                },
                plugins: [{
                    id: 'datalabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                const suffix = i === 0 ? ' L' : ' €';
                                ctx.save();
                                ctx.fillStyle = '#000';
                                ctx.font = 'bold 12px sans-serif';
                                ctx.textAlign = 'left';
                                ctx.textBaseline = 'middle';
                                const x = bar.x - bar.width + 10;
                                const y = bar.y;
                                ctx.fillText(value.toLocaleString() + suffix, Math.max(bar.base + 5, x), y);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });
        }

        function getFilteredReadings(filter) {
            if (filter === 'all') return readings;
            const now = new Date();
            let cutoff;
            if (filter === '3m') cutoff = new Date(now.setMonth(now.getMonth() - 3));
            else if (filter === '6m') cutoff = new Date(now.setMonth(now.getMonth() - 6));
            else cutoff = new Date(now.setFullYear(now.getFullYear() - 1));
            return readings.filter(r => new Date(r.date) >= cutoff);
        }

        function getFilteredRefills(filter) {
            if (filter === 'all') return refills;
            const now = new Date();
            let cutoff;
            if (filter === '3m') cutoff = new Date(now.setMonth(now.getMonth() - 3));
            else if (filter === '6m') cutoff = new Date(now.setMonth(now.getMonth() - 6));
            else cutoff = new Date(now.setFullYear(now.getFullYear() - 1));
            return refills.filter(r => new Date(r.date) >= cutoff);
        }

        function updateHistory() {
            const rl = document.getElementById('readings-list');
            const fl = document.getElementById('refills-list');
            if (rl) rl.innerHTML = readings.length === 0 ? '<div class="empty-state">Aucune lecture</div>' : [...readings].reverse().map(r => `<div class="history-item"><span class="history-date">${formatDate(r.date)}</span><div class="history-values"><span class="history-level">${r.level} L</span><button class="delete-btn" onclick="deleteReading(${r.id})">×</button></div></div>`).join('');
            if (fl) fl.innerHTML = refills.length === 0 ? '<div class="empty-state">Aucune livraison</div>' : [...refills].reverse().map(r => `<div class="history-item"><span class="history-date">${formatDate(r.date)}</span><div class="history-values"><span class="history-liters">${r.liters} L</span><span class="history-price">${r.price} €</span><span class="history-ppl">${r.pricePerLiter} €/L</span><button class="delete-btn" onclick="deleteRefill(${r.id})">×</button></div></div>`).join('');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + (page === 'main' ? 'home' : page)).classList.add('active');
            if (page === 'stats') setTimeout(updateCharts, 100);
        }

        function openModal(type) {
            updateModalDates();
            document.getElementById('modal-' + type).classList.add('show');
            setTimeout(() => document.getElementById(type === 'jauge' ? 'gauge-input' : 'refill-liters').focus(), 300);
        }

        function closeModal(type) {
            document.getElementById('modal-' + type).classList.remove('show');
            if (type === 'jauge') document.getElementById('gauge-input').value = '';
            else { document.getElementById('refill-liters').value = ''; document.getElementById('refill-price').value = ''; document.getElementById('price-preview').style.display = 'none'; }
        }

        function updateModalDates() {
            const today = new Date().toLocaleDateString('fr-FR');
            document.getElementById('modal-date-jauge').textContent = today;
            document.getElementById('modal-date-livraison').textContent = today;
        }

        function setupListeners() {
            const liters = document.getElementById('refill-liters');
            const price = document.getElementById('refill-price');
            const preview = document.getElementById('price-preview');
            const upd = () => { const l = parseFloat(liters.value), p = parseFloat(price.value); if (l > 0 && p > 0) { document.getElementById('calc-price').textContent = (p / l).toFixed(3); preview.style.display = 'block'; } else preview.style.display = 'none'; };
            liters.addEventListener('input', upd);
            price.addEventListener('input', upd);
            document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { 
                if (e.target === o) {
                    if (o.id === 'modal-delete') {
                        closeDeleteModal();
                    } else {
                        closeModal(o.id.replace('modal-', '')); 
                    }
                }
            }));
        }

        function addReading() {
            const val = parseInt(document.getElementById('gauge-input').value);
            const code = document.getElementById('gauge-code').value;
            
            if (isNaN(val) || val < 0 || val > 1000) { showToast('Valeur invalide', true); return; }
            if (hashCode(code) !== VALID_HASH) { showToast('Erreur', true); return; }
            
            readings.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], level: val });
            readings.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData(); 
            updateUI(); 
            closeModal('jauge');
            document.getElementById('gauge-code').value = '';
            showConfirmation(val + ' litres', 'ajouté', "aujourd'hui");
        }

        function addRefill() {
            const l = parseInt(document.getElementById('refill-liters').value);
            const p = parseFloat(document.getElementById('refill-price').value);
            const code = document.getElementById('refill-code').value;
            
            if (isNaN(l) || l <= 0) { showToast('Quantité invalide', true); return; }
            if (isNaN(p) || p <= 0) { showToast('Prix non indiqué', true); return; }
            if (hashCode(code) !== VALID_HASH) { showToast('Erreur', true); return; }
            
            const today = new Date().toISOString().split('T')[0];
            refills.push({ id: Date.now(), date: today, liters: l, price: p, pricePerLiter: (p / l).toFixed(3) });
            refills.sort((a, b) => new Date(a.date) - new Date(b.date));
            readings.push({ id: Date.now() + 1, date: today, level: 1000, type: 'refill' });
            readings.sort((a, b) => new Date(a.date) - new Date(b.date));
            currentDeliveryIndex = 0;
            saveData(); 
            updateUI(); 
            closeModal('livraison');
            document.getElementById('refill-code').value = '';
            showConfirmation(l + ' litres', 'livraison ajoutée', "aujourd'hui");
        }

        let deleteTarget = { type: null, id: null };

        function deleteReading(id) { 
            deleteTarget = { type: 'reading', id: id };
            document.getElementById('delete-code').value = '';
            document.getElementById('modal-delete').classList.add('show');
            setTimeout(() => document.getElementById('delete-code').focus(), 300);
        }
        
        function deleteRefill(id) { 
            deleteTarget = { type: 'refill', id: id };
            document.getElementById('delete-code').value = '';
            document.getElementById('modal-delete').classList.add('show');
            setTimeout(() => document.getElementById('delete-code').focus(), 300);
        }

        function closeDeleteModal() {
            document.getElementById('modal-delete').classList.remove('show');
            deleteTarget = { type: null, id: null };
        }

        function confirmDelete() {
            const code = document.getElementById('delete-code').value;
            if (hashCode(code) === VALID_HASH) {
                if (deleteTarget.type === 'reading') {
                    readings = readings.filter(r => r.id !== deleteTarget.id);
                    showToast('Lecture supprimée ✓');
                } else if (deleteTarget.type === 'refill') {
                    refills = refills.filter(r => r.id !== deleteTarget.id);
                    currentDeliveryIndex = 0;
                    showToast('Livraison supprimée ✓');
                }
                saveData();
                updateUI();
                closeDeleteModal();
            } else {
                showToast('Erreur', true);
                document.getElementById('delete-code').value = '';
                document.getElementById('delete-code').focus();
            }
        }

        let currentLevelFilter = '1y';
        let currentPriceFilter = 'all';

        function setLevelFilter(f) {
            currentLevelFilter = f;
            const grids = document.querySelectorAll('.chart-filters-grid');
            if (grids[0]) {
                grids[0].querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                grids[0].querySelector(`[onclick="setLevelFilter('${f}')"]`).classList.add('active');
            }
            updateLevelChart();
            if (window.innerWidth > window.innerHeight) updateLandscapeChart();
        }

        function setPriceFilter(f) {
            currentPriceFilter = f;
            const grids = document.querySelectorAll('.chart-filters-grid');
            if (grids[1]) {
                grids[1].querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                grids[1].querySelector(`[onclick="setPriceFilter('${f}')"]`).classList.add('active');
            }
            updatePriceChart();
        }

        function setFilter(f) {
            currentLevelFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateCharts();
            if (window.innerWidth > window.innerHeight) updateLandscapeChart();
        }

        function formatDate(d) { return new Date(d).toLocaleDateString('fr-FR'); }
        function formatDateFull(d) { 
            const months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
            const date = new Date(d);
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`; 
        }
        function formatDateShort(d) { return new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' }); }
        function showToast(msg, err = false) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast' + (err ? ' error' : ''); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

        function showConfirmation(value, text, date) {
            const popup = document.getElementById('confirmation-popup');
            document.getElementById('confirmation-value').textContent = value;
            document.getElementById('confirmation-text').textContent = text;
            document.getElementById('confirmation-date').textContent = date;
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 2000);
        }

        function handleTankClick() {
            if (!isLoggedIn) {
                document.getElementById('login-code').value = '';
                document.getElementById('modal-login').classList.add('show');
                setTimeout(() => document.getElementById('login-code').focus(), 300);
            }
        }

        function checkLogin() {
            const code = document.getElementById('login-code').value;
            if (hashCode(code) === VALID_HASH) {
                isLoggedIn = true;
                document.getElementById('modal-login').classList.remove('show');
                document.getElementById('bottomNav').style.display = 'flex';
                document.getElementById('bottomCards').style.display = 'flex';
                document.getElementById('landscapeContainer').style.display = '';
                loadData();
                handleOrientation();
            } else {
                showToast('Erreur', true);
                document.getElementById('login-code').value = '';
            }
        }

        function initLoginState() {
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('bottomCards').style.display = 'none';
            document.getElementById('landscapeContainer').style.display = 'none';
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showToast('Plein écran non disponible', true);
                });
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
